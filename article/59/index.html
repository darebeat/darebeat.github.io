<!DOCTYPE HTML><html lang="zh-CN"><head><meta charset="utf-8"><meta name="keywords" content="SQOOP原理和使用小记, darebeat"><meta name="description" content="不恋过去，不畏将来，活在当下，行所当行，阻挡你前进的最大阻力永远是你自己！"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><meta name="renderer" content="webkit|ie-stand|ie-comp"><meta name="mobile-web-app-capable" content="yes"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><title>SQOOP原理和使用小记 | darebeat</title><link rel="icon" type="image/png" href="/favicon.png"><link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css"><link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css"><link rel="stylesheet" type="text/css" href="/libs/aos/aos.min.css"><link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css"><link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css"><link rel="stylesheet" type="text/css" href="/css/matery.css"><link rel="stylesheet" type="text/css" href="/css/my.css"><script src="/libs/jquery/jquery.min.js"></script><meta name="generator" content="Hexo 6.3.0"><style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style><link rel="alternate" href="/atom.xml" title="darebeat" type="application/atom+xml"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"><link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head><body><header class="navbar-fixed"><nav id="headNav" class="bg-color nav-transparent"><div id="navContainer" class="nav-wrapper container"><div class="brand-logo"> <a href="/" class="waves-effect waves-light"><img src="/medias/logo.png" class="logo-img" alt="LOGO"> <span class="logo-span">darebeat</span></a></div><a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a><ul class="right nav-menu"><li class="hide-on-med-and-down nav-item"><a href="/" class="waves-effect waves-light"><i class="fas fa-home" style="zoom: 0.6;"></i> <span>首页</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/tags" class="waves-effect waves-light"><i class="fas fa-tags" style="zoom: 0.6;"></i> <span>标签</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/categories" class="waves-effect waves-light"><i class="fas fa-bookmark" style="zoom: 0.6;"></i> <span>分类</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/archives" class="waves-effect waves-light"><i class="fas fa-archive" style="zoom: 0.6;"></i> <span>归档</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/about" class="waves-effect waves-light"><i class="fas fa-user-circle" style="zoom: 0.6;"></i> <span>关于</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/friends" class="waves-effect waves-light"><i class="fas fa-address-book" style="zoom: 0.6;"></i> <span>友情链接</span></a></li><li><a href="#searchModal" class="modal-trigger waves-effect waves-light"><i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i></a></li></ul><div id="mobile-nav" class="side-nav sidenav"><div class="mobile-head bg-color"> <img src="/medias/logo.png" class="logo-img circle responsive-img" alt="LOGO"><div class="logo-name">darebeat</div><div class="logo-desc"> 不恋过去，不畏将来，活在当下，行所当行，阻挡你前进的最大阻力永远是你自己！</div></div><ul class="menu-list mobile-menu-list"><li class="m-nav-item"><a href="/" class="waves-effect waves-light"><i class="fa-fw fas fa-home"></i> 首页</a></li><li class="m-nav-item"><a href="/tags" class="waves-effect waves-light"><i class="fa-fw fas fa-tags"></i> 标签</a></li><li class="m-nav-item"><a href="/categories" class="waves-effect waves-light"><i class="fa-fw fas fa-bookmark"></i> 分类</a></li><li class="m-nav-item"><a href="/archives" class="waves-effect waves-light"><i class="fa-fw fas fa-archive"></i> 归档</a></li><li class="m-nav-item"><a href="/about" class="waves-effect waves-light"><i class="fa-fw fas fa-user-circle"></i> 关于</a></li><li class="m-nav-item"><a href="/friends" class="waves-effect waves-light"><i class="fa-fw fas fa-address-book"></i> 友情链接</a></li><li><div class="divider"></div></li><li><a href="https://github.com/darebeat" class="waves-effect waves-light" target="_blank"><i class="fab fa-github-square fa-fw"></i> Fork Me</a></li></ul></div></div><style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style> <a href="https://github.com/darebeat" class="github-corner tooltipped hide-on-med-and-down" target="_blank" data-tooltip="Fork Me" data-position="left" data-delay="50"><svg viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a></nav></header><div class="bg-cover pd-header post-cover" style="background-image: url('/images/card/0059.png')"><div class="container" style="right: 0px;left: 0px;"><div class="row"><div class="col s12 m12 l12"><div class="brand"><h1 class="description center-align post-title">SQOOP原理和使用小记</h1></div></div></div></div></div><main class="post-container content"><link rel="stylesheet" href="/libs/tocbot/tocbot.min.css"><style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style><div class="row"><div id="main-content" class="col s12 m12 l9"><div id="artDetail"><div class="card"><div class="card-content article-info"><div class="row tag-cate"><div class="col s7"><div class="article-tag"> <a href="/tags/etl/"><span class="chip bg-color">etl</span></a> <a href="/tags/sqoop/"><span class="chip bg-color">sqoop</span></a></div></div><div class="col s5 right-align"><div class="post-cate"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/tools/" class="post-category">tools</a></div></div></div><div class="post-info"><div class="post-date info-break-policy"><i class="far fa-calendar-minus fa-fw"></i> 发布日期:&nbsp;&nbsp; 2021-01-31</div><div class="info-break-policy"><i class="far fa-file-word fa-fw"></i> 文章字数:&nbsp;&nbsp; 3.3k</div><div id="busuanzi_container_page_pv" class="info-break-policy"><i class="far fa-eye fa-fw"></i> 阅读次数:&nbsp;&nbsp;<span id="busuanzi_value_page_pv"></span></div></div></div><hr class="clearfix"><link rel="stylesheet" href="/libs/prism/prism.min.css"><div class="card-content article-card-content"><div id="articleContent"><div> <img src="/images/article/0059-001.png" style="width:100%;"></div><p><br></p><h2 id="sqoop简介">Sqoop简介</h2><p>Apache Sqoop（SQL-to-Hadoop）项目旨在协助RDBMS与Hadoop之间进行高效的大数据交流.用户可以在 Sqoop 的帮助下,轻松地把关系型数据库的数据导入到 Hadoop 与其相关的系统 (如HBase和Hive)中；同时也可以把数据从 Hadoop 系统里抽取并导出到关系型数据库里.</p><p>Sqoop是一个在结构化数据和Hadoop之间进行批量数据迁移的工具,结构化数据可以是MySQL、Oracle等RDBMS.Sqoop底层用MapReduce程序实现抽取、转换、加载,MapReduce天生的特性保证了并行化和高容错率,而且相比Kettle等传统ETL工具,任务跑在Hadoop集群上,减少了ETL服务器资源的使用情况.在特定场景下,抽取过程会有很大的性能提升.</p><p>如果要用Sqoop,必须正确安装并配置Hadoop,因为Sqoop依赖于本地的Hadoop环境启动MR程序；MySQL、Oracle等数据库的JDBC驱动也要放到Sqoop的lib目录下.</p><h2 id="sqoop架构">Sqoop架构</h2><h3 id="sqoop1和sqoop2的对比">Sqoop1和Sqoop2的对比</h3><h4 id="sqoop1架构">Sqoop1架构</h4><div> <img src="/images/article/0059-002.png" style="width:100%;"></div><p><br></p><h4 id="sqoop2架构">Sqoop2架构</h4><div> <img src="/images/article/0059-003.png" style="width:100%;"></div><p><br></p><h4 id="对比分析">对比分析</h4><ul><li>1.在架构上,Sqoop1仅仅使用一个Sqoop客户端；Sqoop2引入了Sqoop Server,对Connector实现了集中的管理,其访问方式也变得多样化了,其可以通过REST API、JAVA API、WEB UI以及CLI控制台方式进行访问.</li><li>2.在安全性能方面,在Sqoop1中我们经常用脚本的方式将HDFS中的数据导入到MySQL中,或者反过来将MySQL数据导入到HDFS中,其中在脚本里边都要显示指定MySQL数据库的用户名和密码的,安全性做的不是太完善.在Sqoop2中,如果是通过CLI方式访问的话,会有一个交互过程界面,你输入的密码信息不被看到,同时Sqoop2引入基于角色的安全机制.</li></ul><h4 id="优缺点">优缺点</h4><ul><li>Sqoop1优点: 架构部署简单；</li><li>Sqoop1缺点: 命令行方式容易出错,格式紧耦合,无法支持所有数据类型,安全机制不够完善,例如密码暴漏,安装需要root权限,connector必须符合JDBC模型；</li><li>Sqoop2优点: 多种交互方式,命令行,<code>Web UI</code>,<code>REST API</code>,<code>Conncetor</code>集中化管理,所有的链接安装在<code>Sqoop Server</code>上,完善权限管理机制,Connector规范化,仅仅负责数据的读写；</li><li>Sqoop2缺点: 架构稍复杂,配置部署更繁琐.</li></ul><h2 id="sqoop数据导入原理">Sqoop数据导入原理</h2><h3 id="将数据从关系型数据库导入到hadoop中">将数据从关系型数据库导入到Hadoop中</h3><ul><li><code>Step1</code>: Sqoop与数据库Server通信,获取数据库表的元数据信息</li><li><code>Step2</code>: Sqoop启动一个Map-Only的MR作业,利用元数据信息并行将数据写入Hadoop</li></ul><p>Sqoop在import时,需要制定split-by参数. Sqoop根据不同的split-by参数值来进行切分,然后将切分出来的区域分配到不同map中. 每个map中再处理数据库中获取的一行一行的值,写入到HDFS中. 同时split-by根据不同的参数类型有不同的切分方法,如比较简单的int型,Sqoop会取最大和最小split-by字段值,然后根据传入的num-mappers来确定划分几个区域. 比如<code>select max(split_by),min(split-by) from</code>得到的<code>max(split-by)</code>和<code>min(split-by)</code>分别为1000和1,而num-mappers为2的话,则会分成两个区域(1,500)和(501-100),同时也会分成2个sql给2个map去进行导入操作,分别为: <code>select XXX from table where split-by&gt;=1 and split-by&lt;500</code> 和 <code>select XXX from table where split-by&gt;=501 and split-by&lt;=1000</code>.</p><p>最后每个map各自获取各自SQL中的数据进行导入工作.</p><div> <img src="/images/article/0059-004.png" style="width:100%;"></div><p><br></p><h3 id="大概流程">大概流程</h3><p>1.读取要导入数据的表结构,生成运行类,默认是QueryResult,打成jar包,然后提交给Hadoop</p><p>2.设置好job,主要也就是设置好各个参数</p><p>3.这里就由Hadoop来执行MapReduce来执行Import命令 ① 首先要对数据进行切分,也就是<code>DataSplit,DataDrivenDBInputFormat.getSplits(JobContext job)</code> ② 切分好范围后,写入范围,以便读取<code>DataDrivenDBInputFormat.write(DataOutput output)</code>,这里是<code>lowerBoundQuery and upperBoundQuery</code> ③ 读取上面②写入的范围,<code>DataDrivenDBInputFormat.readFields(DataInput input)</code> ④ 然后创建RecordReader从数据库中读取数据 <code>DataDrivenDBInputFormat.createRecordReader(InputSplit split,TaskAttemptContext context)</code> ⑤ 创建MAP,<code>MapTextImportMapper.setup(Context context)</code> ⑥ RecordReader一行一行从关系型数据库中读取数据,设置好Map的Key和Value,交给<code>MapDBRecordReader.nextKeyValue()</code> ⑦ 运行MAP,<code>mapTextImportMapper.map(LongWritable key,SqoopRecord val,Context context)</code> 最后生成的<code>Key</code>是行数据,由<code>QueryResult</code>生成,<code>Value</code>是<code>NullWritable.get()</code></p><p>4.导入控制 Sqoop不需要每次都导入整张表. 例如,可以指定导入表的部分列.用户也可以在查询中加入WHERE子句（使用—where参数）,以此来限定需要导入的记录.</p><p>5.导入和一致性 在向HDFS导入数据时,重要的是要确保访问的是数据源的一致性快照. 保证一致性的最好方法是在导入时不允许运行任何对表中现有数据进行更新的进程.</p><p>6.增量导入 定期运行导入时一种很常见的方式,这样做可以使HDFS的数据与数据库的数据保持同步. 为此需要识别哪些是新数据. 对于某一行来说,只有当特定列（由—check-column参数指定）的值大于指定值（通过—last-value设置）时,Sqoop才会导入该行数据.</p><p>7.直接模式导入 在Sqoop的文档中将使用外部工具的方法称为直接模式.</p><p>8.导入大对象 “内联”存储大对象,它们会严重影响扫描的性能.因此将大对象与它们的行分开存储,如下图：</p><div> <img src="/images/article/0059-005.png" style="width:100%;"></div><p><br></p><p>由于大对象单条记录太大,无法在内存中实现物化. 为了克服这个困难,当导入大对象数据大于阈值16M时（通过<code>sqoop.inline.lob.length.max</code>设置,以字节为单位）,Sqoop将导入的大对象存储在LobFile格式的单独文件中. LobFile格式能够存储非常大的单条记录（使用了64位的地址空间）,每条记录保存一个大对象. LobFile格式允许客户端持有对记录的引用,而不访问记录内容,对记录的访问通过<code>java.io.InputStream</code>（用于二进制对象）或<code>java.io.Reader</code>（用于字符对象）来实现的. 在导入一条记录时,所有的”正常”字段会在一个文本文件中一起被物化,同时还生成一个指向保存CLOB或BLOB列的LobFile文件的引用.</p><h3 id="举个栗子">举个栗子</h3><h4 id="复制mysql的表结构到hivesqoop命令行">复制MySQL的表结构到Hive–sqoop命令行</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">sqoop create-hive-table \
  --connect "jdbc:mysql://localhost:3306/crm?useUnicode=true&amp;characterEncoding=utf-8" \
  --username root \
  --password 123456 \
  --table ods_t_visit \
  --hive-database crm \
  --hive-table ods_t_visit \
  --fields-terminated-by "|"  \
  --lines-terminated-by "\n"
;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>说明:</p><p>前面4行为myql相关</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">--hive-database crm         # 为制定表所属库为CRM
--hive-table ods_t_visit    # 制定在hive上的表名为ods_t_visit
--fields-terminated-by "|"  # hive表中的数据在hdfs上的字段分隔符号
--lines-terminated-by "\n"  # hive表中的数据在hdfs的每行记录间的分隔符<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h4 id="创建hive表对应的目录">创建Hive表对应的目录</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hadoop fs -mkdir /user/sqoop/crm/ods_t_visit<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="修改表hive表对应的目录-hive终端执行">修改表Hive表对应的目录: HIVE终端执行</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">ALTER TABLE ods_t_visit SET LOCATION 'hdfs://Ucluster/user/sqoop/crm/ods_t_visit';
ALTER TABLE ods_t_visit SET TBLPROPERTIES ('EXTERNAL'='TRUE');<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h4 id="导入数据">导入数据</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">sqoop import --connect "jdbc:mysql://localhost:3306/crm?useUnicode=true&amp;characterEncoding=utf-8" \
  --username root \
  --password 123456 \
  --table ods_t_visit \
  --hive-database crm \
  --hive-table ods_t_visit \
  --null-string '\\N'  \
  --null-non-string '\\N' \
  --hive-drop-import-delims  \
  --target-dir /user/sqoop/crm/ods_t_visit  \
  -m 1 \
  --append \
  --fields-terminated-by '|'
;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>字段说明:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"># 前面部分和创建表时一样
# 将msyql中的Null 导入hive时替换为\N
--null-string '\\N'  \
--null-non-string '\\N' \

# 将mysql中的一些特殊字符去掉,如文本中的\n,避免和hive换行符\n冲突
--hive-drop-import-delims

# 我们之前建的hdfs目录,用来存储数据
--target-dir /user/sqoop/crm/ods_t_visit

# 用几个map 来并行导入,由于该表没有主键,我配置为了1
-m 1  

# 导入已经存在的目录时用此选项,表示追加
--append   <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="增量导入">增量导入</h4><p>增量导入主要是用自增长主键来设置check-column,但是由于我们的表是用Last_updated_at来设置增量,而历史数据中的Last_updated_at也在不断更新</p><p>所以增量导入分成了两步 1.数据导入临时表 2.数据去重</p><h5 id="导入临时表">导入临时表</h5><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">sqoop import --connect "jdbc:mysql://localhost:3306/crm?useUnicode=true&amp;characterEncoding=utf-8" \
--username root \
--password 123456 \
--table ods_t_visit \
--hive-database ods \
--hive-table  ods_t_visit \
--split-by pid \
--check-column last_updated_at  \
--incremental lastmodified  \
--last-value --last-value "2017-09-18 00:00:00"   \
--null-string '\\N'  \
--null-non-string '\\N' \
--hive-drop-import-delims  \
--target-dir /user/sqoop/crm/ods_t_visit  \
-m 1 \
--append  \
--hive-overwrite  \
--fields-terminated-by '|'
;
```  

说明:

```sh
--split-by pid # 根据pid来做拆分
--check-column # last_updated_at
--incremental lastmodified # 增量判断的列
--append # 增量模式
--last-value --last-value "2017-09-18 00:00:00" # 增量取值<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="去重">去重</h5><p>去重是从临时表中执行排重后,将数据<code>overwirte</code>到目标表</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">hive -e "use ods; INSERT OVERWRITE TABLE ods_app_t_visit select id,user_id,page_id,create_time,last_updated_at from (select *, row_number() over (distribute by id sort by id ,last_updated_at desc ) num from ods_app_t_visit_tmp) t where t.num=1;"<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="sqoop数据导出原理">Sqoop数据导出原理</h2><div> <img src="/images/article/0059-006.png" style="width:100%;"></div><p><br></p><p>Sqoop导出功能的架构与其导入功能非常相似,在执行导出操作之前,Sqoop会根据数据库连接字符串来选择一个导出方法,一般为jdbc. 然后,Sqoop会根据目标表的定义生成一个java类.这个生成的类能够从文本文件中解析记录,并能够向表中插入类型合适的值. 接着会启动一个MapReduce作业,从HDFS中读取源数据文件,使用生成的类解析记录,并且执行选定的导出方法. 基于jdbc的导出方法会产生一批insert语句,每条语句都会向目标表中插入多条记录. 多个单独的线程被用于从HDFS读取数据并与数据库进行通信,以确保涉及不同系统的I/O操作能够尽可能重叠执行. 虽然HDFS读取数据的MapReduce作业大多根据所处理文件的数量和大小来选择并行度（Map任务的数量）,但Sqoop的导出工具允许用户明确设定任务的数量. 由于导出性能会受并行的数据库写入线程数量的影响,所以Sqoop使用<code>CombineFileInput</code>类将输入文件分组分配给少数几个Map任务去执行.</p><h3 id="导出与事务">导出与事务</h3><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 进程的并行特性,导致导出操作往往不是原子操作. Sqoop会采用多个并行的任务导出,并且数据库系统使用固定大小的缓冲区来存储事务数据,这时一个任务中的所有操作不可能在一个事务中完成. 因此,在导出操作进行过程中,提交过的中间结果都是可见的. 在导出过程完成前,不要启动那些使用导出结果的应用程序,否则这些应用会看到不完整的导出结果. 为了解决这个问题,Sqoop可以先将数据导出到一个临时阶段表中,然后在导出任务完成前（即导出操作成功执行后）,在一个事务中将临时阶段表中的数据全部移动到目标表中. 使用临时阶段表会降低执行速度,因为它需要写两次数据：先写入临时阶段表,再写入目标表. 整个导出过程运行所使用的的空间也更多,因为从临时阶段表向目标表导出时存在数据的两个复本.</p><h3 id="导出与sequencefile">导出与SequenceFile</h3><p>Sqoop还可以将存储在SequenceFile中的记录导出到输出表,不过有一些限制. SequenceFile中可以保存任意类型的记录. Sqoop的导出工具从SequenceFile中读取对象,然后直接发送到OutputCollector,由它将这些对象传递给数据库导出OutputFormat. 为了能让Sqoop使用,记录必须被保存在SequenceFile键值对格式的值部分,并且必须继承抽象类<code>com.cloudera.sqoop.lib.SqoopRecord</code>.</p><h3 id="举个栗子-1">举个栗子</h3><p>HIVE TO MYSQL</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"># Hive 导入mysql 时,需要先在mysql上提前建立好相应的表
# 为了避免有重复数据,需要加上--update-key
sqoop  export --connect "jdbc:mysql://localhost:3306/ods?useUnicode=true&amp;characterEncoding=gbk" \
  --username root \
  --password  123456  \
  --table ods_credit_account \
  --export-dir /user/sqoop/ods/ods_credit_account \
  --update-key id,member_id \
  -m 10 \
  --input-null-string "\\\\N"  \
  --input-null-non-string "\\\\N" \
  --lines-terminated-by "\n" \
  --update-mode allowinsert \
  --input-fields-terminated-by '|'
;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>说明:</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">--update-key # 为主键字段
--update-mode allowinsert # hdfs文件中存在的记录做更新,不存在的记录则插入<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="sqoop常遇见的错误">Sqoop常遇见的错误</h2><ul><li>1.缺少jdbc导致错误</li><li>2.无法解析的错误 一般会有一下这几种情况：<ul><li>a.分割符的问题: 要么分割符不正确,要么就是数据不纯,有特殊字符,数据中最好不要有像<code>’</code>等特殊字符,不然可能会报无法解析</li><li>b.mysql库和hive库中的表结构不一致.</li><li>c.mysql字段长度不够.</li><li>d.字段格式不匹配.</li><li>e.mysql与hive中的字段不对应(顺序、数目)<br></li><li>f.mysql数据库处于锁表中</li></ul></li><li>3.数据倾斜 解决办法:<ul><li>a.增大m数,缓解数据倾斜</li><li>b.了解数据分布,更改<code>–split-by</code>,或者进行表的拆分</li></ul></li><li>4.<code>–split-by</code>非主键时要特别注意<code>NULL</code>,另外内<code>–split-by</code>对于非数字类型的比如<code>varchar</code>的支持不是特别的好</li></ul></div><hr/><div class="reprint" id="reprint-statement"><div class="reprint__author"> <span class="reprint-meta" style="font-weight: bold;"><i class="fas fa-user">文章作者:</i></span> <span class="reprint-info"><a href="/about" rel="external nofollow noreferrer">darebeat</a></span></div><div class="reprint__type"> <span class="reprint-meta" style="font-weight: bold;"><i class="fas fa-link">文章链接:</i></span> <span class="reprint-info"><a href="https://www.darebeat.cn/article/59/">https://www.darebeat.cn/article/59/</a></span></div><div class="reprint__notice"> <span class="reprint-meta" style="font-weight: bold;"><i class="fas fa-copyright">版权声明:</i></span> <span class="reprint-info">本博客所有文章除特別声明外，均采用 <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a> 许可协议。转载请注明来源 <a href="/about" target="_blank">darebeat</a> !</span></div></div><script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML});
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script><div class="tag_share" style="display: block;"><div class="post-meta__tag-list" style="display: inline-block;"><div class="article-tag"> <a href="/tags/etl/"><span class="chip bg-color">etl</span></a> <a href="/tags/sqoop/"><span class="chip bg-color">sqoop</span></a></div></div><div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;"><link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css"><div id="article-share"><div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div><script src="/libs/share/js/social-share.min.js"></script></div></div></div><style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style><div id="reward"> <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a><div id="rewardModal" class="modal"><div class="modal-content"><a class="close modal-close"><i class="fas fa-times"></i></a><h4 class="reward-title">你的赞赏是我前进的动力！</h4><div class="reward-content"><div class="reward-tabs"><ul class="tabs row"><li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li><li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li></ul><div id="alipay"> <img src="/medias/reward/alipay.png" class="reward-img" alt="支付宝打赏二维码"></div><div id="wechat"> <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码"></div></div></div></div></div></div><script>
    $(function () {
        $('.tabs').tabs();
    });
</script></div></div><article id="prenext-posts" class="prev-next articles"><div class="row article-row"><div class="article col s12 m6" data-aos="fade-up"><div class="article-badge left-badge text-color"><i class="fas fa-chevron-left"></i> &nbsp;上一篇</div><div class="card"><a href="/article/60/"><div class="card-image"> <img src="/images/card/0060.png" class="responsive-img" alt="SHELL命令-常用的日期函数"> <span class="card-title">SHELL命令-常用的日期函数</span></div></a><div class="card-content article-content"><div class="summary block-with-text"> SHELL命令-常用的日期函数。</div><div class="publish-info"><span class="publish-date"><i class="far fa-clock fa-fw icon-date"></i> 2021-02-03</span><span class="publish-author"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/shell/" class="post-category">shell</a></span></div></div><div class="card-action article-tags"> <a href="/tags/date/"><span class="chip bg-color">date</span></a></div></div></div><div class="article col s12 m6" data-aos="fade-up"><div class="article-badge right-badge text-color"> 下一篇&nbsp;<i class="fas fa-chevron-right"></i></div><div class="card"><a href="/article/58/"><div class="card-image"> <img src="/images/card/0058.jpeg" class="responsive-img" alt="DATAX使用小记"> <span class="card-title">DATAX使用小记</span></div></a><div class="card-content article-content"><div class="summary block-with-text"> datax是阿里巴巴内部被广泛使用的离线数据同步工具或平台,通过配置reader+writer的配置方式，实现各种异步数据源之间的数据同步。</div><div class="publish-info"><span class="publish-date"><i class="far fa-clock fa-fw icon-date"></i> 2021-01-25</span><span class="publish-author"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/tools/" class="post-category">tools</a></span></div></div><div class="card-action article-tags"> <a href="/tags/datax/"><span class="chip bg-color">datax</span></a> <a href="/tags/etl/"><span class="chip bg-color">etl</span></a></div></div></div></div></article></div><script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script><script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script><script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script><script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script></div><div id="toc-aside" class="expanded col l3 hide-on-med-and-down"><div class="toc-widget card" style="background-color: white;"><div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div><div id="toc-content"></div></div></div></div><div id="floating-toc-btn" class="hide-on-med-and-down"><a class="btn-floating btn-large bg-color"><i class="fas fa-list-ul"></i></a></div><script src="/libs/tocbot/tocbot.min.js"></script><script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        /* modify the toc link href to support Chinese. */
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        /* modify the heading title id to support Chinese. */
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        /* Set scroll toc fixed. */
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        /* 切换TOC目录展开收缩的相关操作. */
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script></main><footer class="page-footer bg-color"><div class="container row center-align" style="margin-bottom: 15px !important;"><div class="col s12 m8 l8 copy-right"> Copyright&nbsp;&copy; <span id="year">2019-2025</span> &nbsp;|&nbsp;&nbsp;Powered&nbsp;by&nbsp; <a href="/about" target="_blank">darebeat</a><br> <span id="busuanzi_container_site_pv" style='display:none'>|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv" class="white-color"></span>&nbsp;次</span> <span id="busuanzi_container_site_uv" style='display:none'>|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv" class="white-color"></span>&nbsp;人</span><br> <span id="sitetime">载入运行时间...</span><script>
                function siteTime() {
                    var seconds = 1000;
                    var minutes = seconds * 60;
                    var hours = minutes * 60;
                    var days = hours * 24;
                    var years = days * 365;
                    var today = new Date();
                    var startYear = "2019";
                    var startMonth = "5";
                    var startDate = "17";
                    var startHour = "0";
                    var startMinute = "0";
                    var startSecond = "0";
                    var todayYear = today.getFullYear();
                    var todayMonth = today.getMonth() + 1;
                    var todayDate = today.getDate();
                    var todayHour = today.getHours();
                    var todayMinute = today.getMinutes();
                    var todaySecond = today.getSeconds();
                    var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                    var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                    var diff = t2 - t1;
                    var diffYears = Math.floor(diff / years);
                    var diffDays = Math.floor((diff / days) - diffYears * 365);
                    var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                    var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) / minutes);
                    var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours - diffMinutes * minutes) / seconds);
                    if (startYear == todayYear) {
                        document.getElementById("year").innerHTML = todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffDays + " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    } else {
                        document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffYears + " 年 " + diffDays + " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    }
                }
                setInterval(siteTime, 1000);
            </script><br></div><div class="col s12 m4 l4 social-link social-statis"><a href="https://github.com/darebeat" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50"><i class="fab fa-github"></i></a><a href="mailto:darebeat@126.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50"><i class="fas fa-envelope-open"></i></a><a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=871731559" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 871731559" data-position="top" data-delay="50"><i class="fab fa-qq"></i></a><a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50"><i class="fas fa-rss"></i></a></div></div></footer><div class="progress-bar"></div><script>
    $(document).ready(function () {
        /* 50ms周期检测函数 */
        var int = setInterval(fixCount, 50);
        /* 初始化首次数据 */
        var pvcountOffset = 20000;
        var uvcountOffset = 5000;

        function fixCount() {
            if (document.getElementById("busuanzi_container_site_pv").style.display != "none") {
                $("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html()) + pvcountOffset);
                clearInterval(int);
            }
            if ($("#busuanzi_container_site_pv").css("display") != "none") {
                /* 加上初始数据 */
                $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + uvcountOffset);
                /* 停止检测 */
                clearInterval(int);
            }
        }
    });
</script><div id="searchModal" class="modal"><div class="modal-content"><div class="search-header"><span class="title"><i class="fas fa-search"></i> &nbsp;&nbsp;搜索</span> <input type="search" id="searchInput" name="s" value="" placeholder="请输入搜索的关键字，比如:bigdata" class="search-input"></div><div id="searchResult"></div></div></div><script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                /* get the contents from search data */
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    /* perform local searching */
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        /* only match artiles with not empty titles and contents */
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        /* show search results */
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim(); /* .replace(/<[^>]+>/g, ""); */
                            if (first_occur >= 0) {
                                /* cut out 100 characters */
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                /* highlight all keywords */
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>";
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script><div id="backTop" class="top-scroll"><a class="btn-floating btn-large waves-effect waves-light" href="#!"><i class="fas fa-arrow-up"></i></a></div><script src="/libs/materialize/materialize.min.js"></script><script src="/libs/masonry/masonry.pkgd.min.js"></script><script src="/libs/aos/aos.min.js"></script><script src="/libs/scrollprogress/scrollProgress.min.js"></script><script src="/libs/lightGallery/js/lightgallery-all.min.js"></script><script src="/js/matery.js"></script><script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script><script src="/libs/others/clicklove.min.js" async="async"></script><script async src="/libs/others/busuanzi.pure.mini.js"></script><script src="/libs/instantpage/instantpage.min.js" type="module"></script></body></html>